import streamlit as st
from streamlit_gsheets import GSheetsConnection
import pandas as pd
import plotly.express as px
from datetime import date, datetime, timedelta

# --- 1. é é¢è¨­å®š ---
st.set_page_config(page_title="Everyday Moments", layout="centered")

# --- CSS ç¾åŒ– ---
st.markdown("""
    <style>
    .stTextInput input, .stNumberInput input, .stSelectbox, .stDateInput { font-size: 18px !important; }
    div.stButton > button {
        width: 100%; height: 3.5em; font-size: 22px !important; font-weight: bold;
        border-radius: 10px; border: none; margin-top: 10px;
    }
    /* ç¶ è‰²ç¢ºèªæŒ‰éˆ• */
    .save-btn > button { background-color: #FF4B4B; color: white; }
    .save-btn > button:hover { background-color: #E03A3A; color: white; }
    
    /* ç°è‰²åˆªé™¤æŒ‰éˆ• */
    .del-btn > button { background-color: #6c757d; color: white; }
    .del-btn > button:hover { background-color: #5a6268; color: white; }
    </style>
""", unsafe_allow_html=True)

st.title("Everyday Moments")

# --- 2. å»ºç«‹é€£ç·š ---
conn = st.connection("gsheets", type=GSheetsConnection)

# --- 3. è®€å–èˆ‡è™•ç†è³‡æ–™ ---
try:
    df = conn.read(worksheet="Expenses", ttl=0)
    if df.empty:
        df = pd.DataFrame(columns=["Date", "Category", "Amount", "Note"])
    else:
        df["Amount"] = pd.to_numeric(df["Amount"], errors="coerce").fillna(0)
        df["Date_dt"] = pd.to_datetime(df["Date"], errors="coerce")
        df["Month"] = df["Date_dt"].dt.strftime("%Y-%m")
        df["Note"] = df["Note"].fillna("")
except Exception:
    df = pd.DataFrame(columns=["Date", "Category", "Amount", "Note"])

# --- æ™‚é–“æ ¡æ­£ (å°ç£æ™‚å€ UTC+8) ---
taiwan_now = datetime.utcnow() + timedelta(hours=8)
taiwan_date = taiwan_now.date()

# --- 4. è¨˜å¸³è¼¸å…¥å€ (ä¿®æ”¹é»ï¼šæ¨™é¡Œæ”¹ç‚ºç´…å­—å°å£è›‹) ---
with st.expander("ğŸ˜ˆ ç´…å­—å°å£è›‹ï¼Œè¦èŠ±çš„å€¼å¾—ï¼", expanded=True):
    with st.form("entry_form", clear_on_
